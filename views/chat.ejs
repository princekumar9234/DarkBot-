<!DOCTYPE html>
<html lang="en" data-theme="<%= user.preferences.theme === 'system' ? 'dark' : user.preferences.theme %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Chat with DarkBot - your AI-powered assistant.">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent: <%= user.preferences.accentColor || '#8b5cf6' %>; 
            --font-outfit: 'Outfit', sans-serif;
        }
        :root { --accent-hover: color-mix(in srgb, var(--accent) 85%, black); }
        :root { --accent-glow: color-mix(in srgb, var(--accent) 30%, transparent); }
        
        body {
            overflow: hidden !important;
            height: 100vh !important;
            width: 100vw !important;
        }
        
        .welcome-title-main {
            font-family: var(--font-outfit);
            font-weight: 700;
            letter-spacing: -1px;
            font-size: 32px;
            margin-bottom: 32px;
        }
        
        .welcome-logo img {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            box-shadow: 0 0 40px rgba(220, 20, 60, 0.3);
            margin-bottom: 24px;
            transition: transform 0.5s ease;
        }
        
        .welcome-logo:hover img {
            transform: scale(1.1);
        }
        
        .suggestion-btn {
            background: rgba(255, 255, 255, 0.03) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            border-radius: 16px !important;
            padding: 16px !important;
            transition: all 0.3s ease !important;
        }
        
        .suggestion-btn:hover {
            background: rgba(255, 255, 255, 0.08) !important;
            border-color: var(--accent) !important;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Mobile Sidebar Backdrop -->
        <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

        <!-- ============================================ -->
        <!-- Sidebar - ChatGPT Style -->
        <!-- ============================================ -->
        <aside class="sidebar" id="sidebar">
            <!-- Sidebar Top Nav -->
            <div class="sidebar-header">
                <button class="sidebar-nav-btn" id="sidebarCollapseBtn" title="Close sidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="sidebar-nav-btn" id="newChatBtn" title="New chat">
                    <i class="fas fa-pen-to-square"></i>
                </button>
            </div>

            <div class="sidebar-nav">
                <button class="sidebar-nav-item" id="newChatNavBtn">
                    <i class="fas fa-plus"></i>
                    <span>New chat</span>
                </button>
                <button class="sidebar-nav-item" onclick="openSettingsModal()">
                    <i class="fas fa-gear"></i>
                    <span>Settings</span>
                </button>
            </div>

            <div class="sidebar-chats" id="sidebarChats">
                <div class="sidebar-section-title">Your chats</div>
                <!-- Chat items will be dynamically loaded here -->
            </div>

            <div class="sidebar-footer">
                <div class="sidebar-user" id="userProfileBtn">
                    <div class="sidebar-user-avatar" id="userAvatar">
                        <%= user.name.charAt(0).toUpperCase() %>
                    </div>
                    <div class="sidebar-user-info">
                        <span class="sidebar-user-name"><%= user.name %></span>
                        <span class="sidebar-user-email"><%= user.email %></span>
                    </div>
                    <i class="fas fa-ellipsis sidebar-user-menu-icon"></i>
                </div>
                
                <!-- User Profile Dropdown -->
                <div class="user-dropdown" id="userDropdown">
                    <button class="user-dropdown-item" onclick="openSettingsModal()">
                        <i class="fas fa-gear"></i>
                        <span>Settings</span>
                    </button>
                    <button class="user-dropdown-item" id="logoutBtn">
                        <i class="fas fa-arrow-right-from-bracket"></i>
                        <span>Log out</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- ============================================ -->
        <!-- Main Content -->
        <!-- ============================================ -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn sidebar-toggle-mobile" id="mobileSidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
                <div class="topbar-center">
                    <div class="topbar-title-pill">
                        <img src="/img/sharingan-logo.svg" style="width: 20px; height: 20px; border-radius: 50%; object-fit: cover; margin-right: 4px;" onerror="this.style.display='none'">
                        <span>DarkBot</span>
                        <i class="fas fa-chevron-down" style="font-size: 10px; opacity: 0.5; margin-left: 4px;"></i>
                    </div>
                </div>
                <div class="topbar-right">
                    <button class="topbar-btn" id="shareChatBtn" title="Share Chat">
                        <i class="fas fa-share-nodes"></i>
                    </button>
                    <button class="topbar-btn" id="newChatTopBtn" title="New Chat">
                        <i class="fas fa-pen-to-square"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div class="chat-area" id="chatArea">
                <div class="messages-container" id="messagesContainer">
                    <!-- Welcome Screen - ChatGPT Style -->
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-logo">
                            <img src="/img/sharingan-logo.svg" alt="DarkBot Logo" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3504/3504780.png'">
                        </div>
                        <h1 class="welcome-title-main">What can I help with?</h1>
                        <div class="welcome-suggestions">
                            <button class="suggestion-btn" onclick="setPrompt('Create an image of ')">
                                <i class="fas fa-image text-green"></i> 
                                <span>Create image</span>
                            </button>
                            <button class="suggestion-btn" onclick="setPrompt('Help me write ')">
                                <i class="fas fa-pen-nib text-purple"></i> 
                                <span>Help me write</span>
                            </button>
                            <button class="suggestion-btn" onclick="setPrompt('Summarize text ')">
                                <i class="fas fa-file-alt text-orange"></i> 
                                <span>Summarize text</span>
                            </button>
                            <button class="suggestion-btn" onclick="setPrompt('Brainstorm ideas for ')">
                                <i class="fas fa-lightbulb text-yellow"></i> 
                                <span>Brainstorm</span>
                            </button>
                        </div>
                    </div>

                    <!-- Messages will be appended here -->
                </div>
            </div>

            <!-- Input Area - ChatGPT Style Pill -->
            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-container" id="inputContainer">
                        <button class="input-extra-btn" title="Add" id="addBtn">
                            <i class="fas fa-plus"></i>
                        </button>
                        <input type="file" id="fileInput" hidden multiple accept="image/*,.pdf,.txt">

                        <!-- Extra Menu Popup -->
                        <div class="extra-menu" id="extraMenu">
                            <button class="extra-menu-item" id="uploadFileMenuBtn">
                                <i class="fas fa-paperclip"></i>
                                <span>Add photos & files</span>
                            </button>
                            <button class="extra-menu-item">
                                <i class="fas fa-image"></i>
                                <span>Create image</span>
                            </button>
                            <button class="extra-menu-item">
                                <i class="fas fa-lightbulb"></i>
                                <span>Thinking</span>
                            </button>
                            <button class="extra-menu-item">
                                <i class="fas fa-book-open"></i>
                                <span>Study and learn</span>
                            </button>
                            <button class="extra-menu-item">
                                <i class="fas fa-globe"></i>
                                <span>Web search</span>
                            </button>
                            <div class="extra-menu-divider"></div>
                            <button class="extra-menu-item">
                                <i class="fas fa-ellipsis-h"></i>
                                <span>More</span>
                            </button>
                        </div>
                        
                        <div class="input-content">
                            <div id="filePreviewContainer" class="file-preview-container"></div>
                            <textarea
                                id="chatInput"
                                class="chat-input"
                                placeholder="Message DarkBot"
                                rows="1"
                            ></textarea>
                        </div>
                        <div class="input-right-actions">
                            <button class="input-icon-btn mobile-only" title="Voice">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="send-btn" id="sendBtn" disabled title="Send message">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button class="input-icon-btn mobile-only wave-icon" title="Audio">
                                <i class="fas fa-waveform"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="input-footer">
                    DarkBot can make mistakes. Check important info.
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirm Action</h3>
                <button class="modal-close" onclick="closeModal('confirmModal')">
                    <i class="fas fa-xmark"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="settings-btn outline" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="settings-btn danger" id="confirmAction">Delete</button>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // DarkBot Chat - Client-Side Logic
    // ============================================

    // State
    let currentChatId = null;
    let isLoading = false;
    const currentUser = JSON.parse(decodeURIComponent('<%= encodeURIComponent(JSON.stringify(user || {})) %>'));
    const aiProvider = currentUser.preferences?.aiProvider || 'gemini';

    // DOM Elements
    const chatArea = document.getElementById('chatArea');
    const messagesContainer = document.getElementById('messagesContainer');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop');
    const sidebarChats = document.getElementById('sidebarChats');

    // ============================================
    // Theme System
    // ============================================
    function applySystemTheme() {
        if (currentUser.preferences?.theme === 'system') {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        }
    }
    applySystemTheme();
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applySystemTheme);

    // Sidebar Toggle
    // ============================================
    const mobileSidebarToggle = document.getElementById('mobileSidebarToggle');
    
    function toggleSidebar() {
        const isCollapsed = sidebar.classList.toggle('collapsed');
        // Only show backdrop on mobile
        if (window.innerWidth <= 768) {
            sidebarBackdrop.classList.toggle('active', !isCollapsed);
        }
    }

    // Desktop Toggle (Hamburger inside sidebar)
    document.getElementById('sidebarCollapseBtn').addEventListener('click', toggleSidebar);

    // Mobile Toggle (Hamburger in topbar)
    if (mobileSidebarToggle) {
        mobileSidebarToggle.addEventListener('click', () => {
             sidebar.classList.remove('collapsed');
             sidebarBackdrop.classList.add('active');
        });
    }

    sidebarBackdrop.addEventListener('click', () => {
        sidebar.classList.add('collapsed');
        sidebarBackdrop.classList.remove('active');
    });

    // Initialization: Collapse on mobile, open on desktop
    if (window.innerWidth <= 768) {
        sidebar.classList.add('collapsed');
    } else {
        sidebar.classList.remove('collapsed');
    }

    // ============================================
    // User Profile Dropdown
    // ============================================
    const userProfileBtn = document.getElementById('userProfileBtn');
    const userDropdown = document.getElementById('userDropdown');

    userProfileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = userDropdown.classList.toggle('active');
        userProfileBtn.classList.toggle('dropdown-open', isActive);
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!userDropdown.contains(e.target) && !userProfileBtn.contains(e.target)) {
            userDropdown.classList.remove('active');
            userProfileBtn.classList.remove('dropdown-open');
        }
    });

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
            const res = await fetch('/auth/logout', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                window.location.href = '/login';
            }
        } catch (err) {
            console.error('Logout failed:', err);
        }
    });

    // ============================================
    // Textarea Auto-resize
    // ============================================
    chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
        sendBtn.disabled = !chatInput.value.trim();
    });

    // Send message on Enter
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (chatInput.value.trim() && !isLoading) {
                sendMessage();
            }
        }
    });

    sendBtn.addEventListener('click', () => {
        if (chatInput.value.trim() && !isLoading) {
            sendMessage();
        }
    });

    // ============================================
    // Extra Menu (+) Logic
    // ============================================
    const addBtn = document.getElementById('addBtn');
    const extraMenu = document.getElementById('extraMenu');

    if (addBtn && extraMenu) {
        addBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            extraMenu.classList.toggle('active');
        });

        // Close when clicking outside
        document.addEventListener('click', (e) => {
            if (!extraMenu.contains(e.target) && !addBtn.contains(e.target)) {
                extraMenu.classList.remove('active');
            }
        });
    }

    // ============================================
    // File Upload Logic
    // ============================================
    const fileInput = document.getElementById('fileInput');
    const uploadFileMenuBtn = document.getElementById('uploadFileMenuBtn');
    const filePreviewContainer = document.getElementById('filePreviewContainer');
    let selectedFiles = [];

    if (uploadFileMenuBtn) {
        uploadFileMenuBtn.addEventListener('click', () => {
            fileInput.click();
            extraMenu.classList.remove('active');
        });
    }

    fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        handleFiles(files);
        fileInput.value = ''; // Reset for same file selection
    });

    function handleFiles(files) {
        files.forEach(file => {
            if (selectedFiles.length >= 5) {
                showToast('Maximum 5 files allowed.', 'error');
                return;
            }
            
            selectedFiles.push(file);
            renderFilePreview(file);
        });
    }

    function renderFilePreview(file) {
        const previewItem = document.createElement('div');
        previewItem.className = 'file-preview-item';
        
        const isImage = file.type.startsWith('image/');
        
        if (isImage) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewItem.innerHTML = `
                    <img src="${e.target.result}" alt="${file.name}">
                    <div class="remove-file-btn"><i class="fas fa-times"></i></div>
                `;
            };
            reader.readAsDataURL(file);
        } else {
            const iconClass = file.type.includes('pdf') ? 'fa-file-pdf' : 'fa-file-alt';
            previewItem.innerHTML = `
                <i class="fas ${iconClass}"></i>
                <div class="file-preview-name">${file.name}</div>
                <div class="remove-file-btn"><i class="fas fa-times"></i></div>
            `;
        }

        previewItem.querySelector('.remove-file-btn').addEventListener('click', () => {
            selectedFiles = selectedFiles.filter(f => f !== file);
            previewItem.remove();
        });

        filePreviewContainer.appendChild(previewItem);
    }

    function clearFiles() {
        selectedFiles = [];
        filePreviewContainer.innerHTML = '';
    }

    // New Chat
    // ============================================
    document.getElementById('newChatBtn').addEventListener('click', startNewChat);
    document.getElementById('newChatNavBtn').addEventListener('click', startNewChat);
    document.getElementById('newChatTopBtn').addEventListener('click', startNewChat);
    
    const shareBtn = document.getElementById('shareChatBtn');
    if (shareBtn) {
        shareBtn.addEventListener('click', () => {
            const shareUrl = window.location.origin + '/chat/' + (currentChatId || '');
            navigator.clipboard.writeText(shareUrl).then(() => {
                showToast('Chat link copied!', 'success');
            });
        });
    }

    function startNewChat() {
        currentChatId = null;
        // Clear messages
        const messages = messagesContainer.querySelectorAll('.message, .typing-indicator');
        messages.forEach(m => m.remove());
        
        welcomeScreen.style.display = 'flex';
        chatInput.value = '';
        chatInput.style.height = 'auto';
        chatInput.focus();

        // Hide Share button
        if (shareBtn) shareBtn.classList.add('hidden');

        // Deselect sidebar items
        document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));

        // Close sidebar on mobile
        if (window.innerWidth <= 768) {
            sidebar.classList.add('collapsed');
            sidebarBackdrop.classList.remove('active');
        }
    }

    // ============================================
    // Send Message
    // ============================================
    async function sendMessage() {
        const message = chatInput.value.trim();
        if ((!message && selectedFiles.length === 0) || isLoading) return;

        isLoading = true;
        sendBtn.disabled = true;

        // Hide welcome screen
        welcomeScreen.style.display = 'none';

        // Add user message to chat
        addMessage('user', message, selectedFiles);

        const formData = new FormData();
        formData.append('message', message);
        formData.append('chatId', currentChatId || '');
        formData.append('aiProvider', aiProvider);
        
        selectedFiles.forEach(file => {
            formData.append('files', file);
        });

        // Clear input & files
        chatInput.value = '';
        chatInput.style.height = 'auto';
        clearFiles();

        // Show typing indicator
        showTypingIndicator();

        try {
            const res = await fetch('/chat/send', {
                method: 'POST',
                body: formData
            });

            const data = await res.json();

            // Remove typing indicator
            removeTypingIndicator();

            if (data.success) {
                currentChatId = data.chatId;

                // Add AI response
                addMessage('assistant', data.response);

                // Refresh sidebar
                loadChatHistory();
            } else {
                addMessage('assistant', '‚ö†Ô∏è ' + (data.message || 'Something went wrong. Please try again.'));
            }
        } catch (err) {
            removeTypingIndicator();
            addMessage('assistant', '‚ö†Ô∏è Network error. Please check your connection and try again.');
        }

        isLoading = false;
        sendBtn.disabled = false;
        chatInput.focus();
    }

    // ============================================
    // Message Rendering
    // ============================================
    // ============================================
    // Message Rendering
    // ============================================
    function addMessage(role, content, files = []) {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${role}`;

        // Configure marked for markdown
        marked.setOptions({ breaks: true, gfm: true, highlight: false });

        const renderedContent = role === 'assistant'
            ? marked.parse(content)
            : escapeHtml(content).replace(/\n/g, '<br>');

        let attachmentsHtml = '';
        if (files && files.length > 0) {
            attachmentsHtml = '<div class="message-attachments">';
            files.forEach(file => {
                const isImage = file.type.startsWith('image/');
                if (isImage) {
                    const url = URL.createObjectURL(file);
                    attachmentsHtml += `
                        <div class="attachment-item image">
                            <img src="${url}" alt="${file.name}" onclick="window.open('${url}')">
                        </div>`;
                } else {
                    const iconClass = file.type.includes('pdf') ? 'fa-file-pdf' : 'fa-file-alt';
                    attachmentsHtml += `
                        <div class="attachment-item file">
                            <i class="fas ${iconClass}"></i>
                            <span>${file.name}</span>
                        </div>`;
                }
            });
            attachmentsHtml += '</div>';
        }

        if (role === 'user') {
            messageEl.innerHTML = `
                <div class="message-body">
                    ${attachmentsHtml}
                    <div class="message-content">${renderedContent}</div>
                </div>
            `;
        } else {
            // Assistant Message
            const avatar = '<img src="/img/sharingan-logo.svg" onerror="this.src=\'https://cdn-icons-png.flaticon.com/512/3504/3504780.png\'" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">'; 
            messageEl.innerHTML = `
                <div class="message-row">
                    <div class="message-avatar">${avatar}</div>
                    <div class="message-body">
                        <div class="message-role">DarkBot</div>
                        <div class="message-content">${renderedContent}</div>
                    </div>
                </div>
                <div class="message-actions">
                    <button class="action-btn" title="Copy" onclick="copyMessageText(this)">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="action-btn" title="Regenerate" onclick="regenerateResponse()">
                        <i class="fas fa-rotate-right"></i>
                    </button>
                    ${role === 'assistant' ? `
                    <button class="action-btn" title="Good response">
                        <i class="fas fa-thumbs-up"></i>
                    </button>
                    <button class="action-btn" title="Bad response">
                        <i class="fas fa-thumbs-down"></i>
                    </button>
                    ` : ''}
                </div>
            `;
            
            // Show Share button when AI responds
            if (shareBtn) shareBtn.classList.remove('hidden');
        }

        messagesContainer.appendChild(messageEl);

        // Syntax highlighting logic (same as before)
        if (role === 'assistant') {
            messageEl.querySelectorAll('pre').forEach(pre => {
                const code = pre.querySelector('code');
                if (code) {
                    const lang = (code.className || '').replace('language-', '') || 'code';
                    const header = document.createElement('div');
                    header.className = 'code-block-header';
                    header.innerHTML = `<span>${lang}</span><button class="copy-code-btn" onclick="copyCode(this)"><i class="fas fa-copy"></i> Copy</button>`;
                    pre.insertBefore(header, code);
                }
            });
        }

        scrollToBottom();
    }

    function copyMessageText(btn) {
        const content = btn.closest('.message').querySelector('.message-content').innerText;
        navigator.clipboard.writeText(content).then(() => {
            const originalIcon = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check"></i>';
            setTimeout(() => btn.innerHTML = originalIcon, 2000);
        });
    }

    // Placeholder for regenerate (user needs to implement logic)
    function regenerateResponse() {
        // Logic to resend last user message
        const messages = document.querySelectorAll('.message.user');
        if (messages.length > 0) {
            const lastMsg = messages[messages.length - 1].innerText;
            setPrompt(lastMsg);
            // Optionally auto-submit: sendMessage();
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function copyCode(btn) {
        const pre = btn.closest('pre');
        const code = pre.querySelector('code');
        navigator.clipboard.writeText(code.textContent).then(() => {
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-copy"></i> Copy';
            }, 2000);
        });
    }

    function setPrompt(text) {
        chatInput.value = text;
        chatInput.focus();
        // Trigger auto-resize logic
        chatInput.dispatchEvent(new Event('input'));
        sendBtn.disabled = false;
    }

    // ============================================
    // Typing Indicator
    // ============================================
    function showTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'typing-indicator';
        indicator.id = 'typingIndicator';
        indicator.innerHTML = `
            <div class="message-avatar" style="background: linear-gradient(135deg, var(--accent), #3b82f6); color: white;">ü§ñ</div>
            <div class="message-body">
                <div class="message-role">DarkBot</div>
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;
        messagesContainer.appendChild(indicator);
        scrollToBottom();
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    // ============================================
    // Scroll to Bottom
    // ============================================
    function scrollToBottom() {
        chatArea.scrollTo({
            top: chatArea.scrollHeight,
            behavior: 'smooth'
        });
    }

    // ============================================
    // Chat History
    // ============================================
    async function loadChatHistory() {
        try {
            const res = await fetch('/chat/history');
            const data = await res.json();

            if (data.success) {
                renderChatHistory(data.chats);
            }
        } catch (err) {
            console.error('Failed to load chat history:', err);
        }
    }

    function renderChatHistory(chats) {
        // Keep the section title
        sidebarChats.innerHTML = '<div class="sidebar-section-title">Your chats</div>';

        if (chats.length === 0) {
            sidebarChats.innerHTML += `
                <div style="text-align: center; padding: 20px; color: var(--text-tertiary); font-size: 13px;">
                    No chats yet. Start a new conversation!
                </div>
            `;
            return;
        }

        chats.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = `chat-item ${chat._id === currentChatId ? 'active' : ''}`;
            chatItem.setAttribute('data-id', chat._id);
            chatItem.innerHTML = `
                <i class="fas fa-message chat-item-icon"></i>
                <span class="chat-item-title">${escapeHtml(chat.title)}</span>
                <button class="chat-item-menu" data-chat-id="${chat._id}" title="More options">
                    <i class="fas fa-ellipsis"></i>
                </button>
            `;
            
            // Click to load chat
            chatItem.addEventListener('click', (e) => {
                if (!e.target.closest('.chat-item-menu')) {
                    loadChat(chat._id);
                }
            });

            // Right-click context menu
            chatItem.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showChatContextMenu(e, chat._id);
            });

            // Three dots menu click
            const menuBtn = chatItem.querySelector('.chat-item-menu');
            menuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showChatContextMenu(e, chat._id);
            });

            sidebarChats.appendChild(chatItem);
        });
    }

    // ============================================
    // Chat Context Menu
    // ============================================
    let currentContextMenu = null;

    function showChatContextMenu(event, chatId) {
        // Remove existing menu
        if (currentContextMenu) {
            currentContextMenu.remove();
        }

        // Create context menu
        const menu = document.createElement('div');
        menu.className = 'chat-context-menu';
        menu.innerHTML = `
            <button class="context-menu-item" data-action="rename">
                <i class="fas fa-pen"></i>
                <span>Rename</span>
            </button>
            <button class="context-menu-item danger" data-action="delete">
                <i class="fas fa-trash"></i>
                <span>Delete</span>
            </button>
        `;

        // Position menu
        document.body.appendChild(menu);
        
        const x = event.clientX;
        const y = event.clientY;
        const menuRect = menu.getBoundingClientRect();
        
        // Adjust position if menu goes off screen
        const left = (x + menuRect.width > window.innerWidth) ? x - menuRect.width : x;
        const top = (y + menuRect.height > window.innerHeight) ? y - menuRect.height : y;
        
        menu.style.left = left + 'px';
        menu.style.top = top + 'px';
        menu.classList.add('active');

        currentContextMenu = menu;

        // Handle menu actions
        menu.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', () => {
                const action = item.getAttribute('data-action');
                if (action === 'delete') {
                    deleteChat(chatId);
                } else if (action === 'rename') {
                    // TODO: Implement rename functionality
                    showToast('Rename feature coming soon!', 'info');
                }
                menu.remove();
                currentContextMenu = null;
            });
        });

        // Close menu on outside click
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    currentContextMenu = null;
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 0);
    }

    // ============================================
    // Load Specific Chat
    // ============================================
    async function loadChat(chatId) {
        try {
            const res = await fetch(`/chat/${chatId}`);
            const data = await res.json();

            if (data.success) {
                currentChatId = chatId;

                // Clear current messages
                const messages = messagesContainer.querySelectorAll('.message, .typing-indicator');
                messages.forEach(m => m.remove());
                welcomeScreen.style.display = 'none';

                // Add messages
                data.chat.messages.forEach(msg => {
                    if (msg.role === 'user' || msg.role === 'assistant') {
                        addMessage(msg.role, msg.content);
                    }
                });
                
                // Toggle Share button
                const shareBtn = document.getElementById('shareChatBtn');
                if (data.chat.messages.length > 0) {
                    shareBtn.classList.remove('hidden');
                } else {
                    shareBtn.classList.add('hidden');
                }

                // Update active state
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.toggle('active', item.getAttribute('data-id') === chatId);
                });

                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    sidebar.classList.add('collapsed');
                    sidebarBackdrop.classList.remove('active');
                }
            }
        } catch (err) {
            showToast('Failed to load chat', 'error');
        }
    }

    // ============================================
    // Delete Chat
    // ============================================
    function deleteChat(chatId) {
        showConfirm('Delete Chat', 'Are you sure you want to delete this chat?', async () => {
            try {
                const res = await fetch(`/chat/${chatId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    if (currentChatId === chatId) {
                        startNewChat();
                    }
                    loadChatHistory();
                    showToast('Chat deleted', 'success');
                }
            } catch (err) {
                showToast('Failed to delete chat', 'error');
            }
        });
    }

    // ============================================
    // Confirm Modal
    // ============================================
    function showConfirm(title, message, onConfirm) {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmModal').classList.add('active');

        const actionBtn = document.getElementById('confirmAction');
        const newBtn = actionBtn.cloneNode(true);
        actionBtn.parentNode.replaceChild(newBtn, actionBtn);
        newBtn.id = 'confirmAction';
        newBtn.addEventListener('click', () => {
            closeModal('confirmModal');
            onConfirm();
        });
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // Close modal on overlay click
    document.getElementById('confirmModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal('confirmModal');
    });

    // ============================================
    // Toast Notifications
    // ============================================
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icon = type === 'success' ? 'fa-check-circle'
            : type === 'error' ? 'fa-exclamation-circle'
            : 'fa-info-circle';

        toast.innerHTML = `<i class="fas ${icon}"></i>${message}`;
        container.appendChild(toast);

        setTimeout(() => toast.remove(), 4000);
    }

    // ============================================
    // Settings Modal Logic
    // ============================================
    function openSettingsModal() {
        document.getElementById('settingsModal').classList.add('active');
        if (typeof userDropdown !== 'undefined' && userDropdown) userDropdown.classList.remove('active');
    }

    // Tab Switching
    document.querySelectorAll('.settings-nav-item').forEach(item => {
        item.addEventListener('click', () => {
            const tabId = item.getAttribute('data-tab');
            
            // Update nav active state
            document.querySelectorAll('.settings-nav-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            
            // Update content visibility
            document.querySelectorAll('.settings-section-block').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tabId}`).classList.add('active');
            
            // Update title
            document.getElementById('settingsTabTitle').textContent = item.querySelector('span').textContent;
        });
    });

    async function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme === 'system' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme);
        await updatePreferences({ theme });
    }

    async function setAccentColor(color) {
        document.documentElement.style.setProperty('--accent', color);
        await updatePreferences({ accentColor: color });
    }

    async function setAiProvider(provider) {
        await updatePreferences({ aiProvider: provider });
        showToast('AI Provider updated. Restarting chat...', 'success');
        setTimeout(() => location.reload(), 1000);
    }

    async function updatePreferences(data) {
        try {
            const response = await fetch('/user/preferences', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                showToast('Settings saved', 'success');
            }
        } catch (err) {
            console.error('Error updating preferences:', err);
            showToast('Failed to save settings', 'error');
        }
    }

    async function logout() {
        try {
            await fetch('/auth/logout', { method: 'POST' });
            window.location.href = '/login';
        } catch (err) {
            console.error('Logout failed:', err);
        }
    }

    // Close settings on outside click
    const settingsModal = document.getElementById('settingsModal');
    if (settingsModal) {
        settingsModal.addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeModal('settingsModal');
        });
    }

    // ============================================
    loadChatHistory();
    chatInput.focus();
    </script>
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal modal-settings">
            <button class="modal-close" onclick="closeModal('settingsModal')">
                <i class="fas fa-xmark"></i>
            </button>
            
            <aside class="settings-sidebar">
                <div class="settings-sidebar-header">
                    <span style="font-weight: 700; font-size: 16px; color: #fff;">Settings</span>
                </div>
                <nav class="settings-nav">
                    <button class="settings-nav-item active" data-tab="general">
                        <i class="fas fa-sliders"></i>
                        <span>General</span>
                    </button>
                    <button class="settings-nav-item" data-tab="notifications">
                        <i class="fas fa-bell"></i>
                        <span>Notifications</span>
                    </button>
                    <button class="settings-nav-item" data-tab="personalization">
                        <i class="fas fa-user-gear"></i>
                        <span>Personalization</span>
                    </button>
                    <button class="settings-nav-item" data-tab="apps">
                        <i class="fas fa-th-large"></i>
                        <span>Apps</span>
                    </button>
                    <button class="settings-nav-item" data-tab="data">
                        <i class="fas fa-database"></i>
                        <span>Data controls</span>
                    </button>
                    <button class="settings-nav-item" data-tab="security">
                        <i class="fas fa-shield-halved"></i>
                        <span>Security</span>
                    </button>
                    <button class="settings-nav-item" data-tab="account">
                        <i class="fas fa-user"></i>
                        <span>Account</span>
                    </button>
                </nav>
            </aside>

            <main class="settings-content">
                <header class="settings-content-header">
                    <h2 id="settingsTabTitle">General</h2>
                </header>
                
                <section class="settings-content-body">
                    <!-- General Tab -->
                    <div class="settings-section-block active" id="tab-general">
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Appearance</div>
                            </div>
                            <div class="settings-control">
                                <div class="settings-select-wrapper">
                                    <select class="settings-select" onchange="setTheme(this.value)">
                                        <option value="system" <%= user.preferences.theme === 'system' ? 'selected' : '' %>>System</option>
                                        <option value="dark" <%= user.preferences.theme === 'dark' ? 'selected' : '' %>>Dark</option>
                                        <option value="light" <%= user.preferences.theme === 'light' ? 'selected' : '' %>>Light</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Accent color</div>
                            </div>
                            <div class="settings-control">
                                <div class="settings-select-wrapper">
                                    <select class="settings-select" onchange="setAccentColor(this.value)">
                                        <option value="#8b5cf6" <%= user.preferences.accentColor === '#8b5cf6' ? 'selected' : '' %>>Default</option>
                                        <option value="#3b82f6" <%= user.preferences.accentColor === '#3b82f6' ? 'selected' : '' %>>Blue</option>
                                        <option value="#10b981" <%= user.preferences.accentColor === '#10b981' ? 'selected' : '' %>>Green</option>
                                        <option value="#ef4444" <%= user.preferences.accentColor === '#ef4444' ? 'selected' : '' %>>Red</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="settings-row" style="opacity: 0.6;">
                            <div class="settings-info">
                                <div class="settings-label">Language</div>
                            </div>
                            <div class="settings-control">
                                <div class="settings-select-wrapper">
                                    <select class="settings-select" disabled>
                                        <option>Auto-detect</option>
                                        <option>English</option>
                                        <option>Hindi</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="settings-row" style="opacity: 0.6;">
                            <div class="settings-info">
                                <div class="settings-label">Spoken language</div>
                                <div class="settings-desc">For best results, select the language you mainly speak. If it's not listed, it may still be supported via auto-detection.</div>
                            </div>
                            <div class="settings-control">
                                <div class="settings-select-wrapper">
                                    <select class="settings-select" disabled>
                                        <option>Auto-detect</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Voice</div>
                            </div>
                            <div class="settings-control">
                                <div class="settings-voice-preview">
                                    <button class="settings-btn-play">
                                        <i class="fas fa-play"></i>
                                        <span>Play</span>
                                    </button>
                                    <div class="settings-select-wrapper">
                                        <select class="settings-select">
                                            <option>Sol</option>
                                            <option>Luna</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Separate Voice</div>
                                <div class="settings-desc">Keep ChatGPT Voice in a separate full screen, without real time transcripts and visuals.</div>
                            </div>
                            <div class="settings-control">
                                <div class="settings-toggle" id="separateVoiceToggle" onclick="this.classList.toggle('active')"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Personalization Tab -->
                    <div class="settings-section-block" id="tab-personalization">
                         <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">AI Engine</div>
                                <div class="settings-desc">Choose your default AI provider</div>
                            </div>
                            <div class="settings-control">
                                <div class="settings-select-wrapper">
                                    <select class="settings-select" onchange="setAiProvider(this.value)">
                                        <option value="gemini" <%= user.preferences.aiProvider === 'gemini' ? 'selected' : '' %>>Gemini Flash</option>
                                        <option value="openai" <%= user.preferences.aiProvider === 'openai' ? 'selected' : '' %>>GPT-4o</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Data Tab -->
                    <div class="settings-section-block" id="tab-data">
                         <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Clear Chat History</div>
                                <div class="settings-desc">Permanently delete all your conversations</div>
                            </div>
                            <div class="settings-control">
                                <button class="settings-btn-play" style="color: #ef4444; border-color: rgba(239, 68, 68, 0.2);" onclick="clearAllChats()">
                                    <i class="fas fa-trash"></i>
                                    <span>Delete All</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Account Tab -->
                    <div class="settings-section-block" id="tab-account">
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Name</div>
                                <div class="settings-desc"><%= user.name %></div>
                            </div>
                        </div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Email</div>
                                <div class="settings-desc"><%= user.email %></div>
                            </div>
                        </div>
                        <div class="settings-row">
                            <div class="settings-info">
                                <div class="settings-label">Log Out</div>
                            </div>
                            <div class="settings-control">
                                <button class="settings-btn-play" onclick="logout()">
                                    <i class="fas fa-right-from-bracket"></i>
                                    <span>Log out</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- placeholders for other tabs -->
                    <div class="settings-section-block" id="tab-notifications">
                        <div style="text-align: center; padding: 40px; color: #8e8e8e;">Notification settings coming soon.</div>
                    </div>
                    <div class="settings-section-block" id="tab-apps">
                        <div style="text-align: center; padding: 40px; color: #8e8e8e;">App integrations coming soon.</div>
                    </div>
                    <div class="settings-section-block" id="tab-security">
                        <div style="text-align: center; padding: 40px; color: #8e8e8e;">Security features coming soon.</div>
                    </div>
                </section>
            </main>
        </div>
    </div>
</body>
</html>
