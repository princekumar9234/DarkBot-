<!DOCTYPE html>
<html lang="en" data-theme="<%= user.preferences.theme === 'system' ? 'dark' : user.preferences.theme %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Chat with DarkBot - your AI-powered assistant.">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root { --accent: <%= user.preferences.accentColor || '#8b5cf6' %>; }
        :root { --accent-hover: color-mix(in srgb, var(--accent) 85%, black); }
        :root { --accent-glow: color-mix(in srgb, var(--accent) 30%, transparent); }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Mobile Sidebar Backdrop -->
        <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

        <!-- ============================================ -->
        <!-- Sidebar - ChatGPT Style -->
        <!-- ============================================ -->
        <aside class="sidebar" id="sidebar">
            <!-- Sidebar Top Nav -->
            <div class="sidebar-header">
                <button class="sidebar-nav-btn" id="sidebarCollapseBtn" title="Close sidebar">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="sidebar-nav-btn" id="newChatBtn" title="New chat">
                    <i class="fas fa-pen-to-square"></i>
                </button>
            </div>

            <div class="sidebar-nav">
                <button class="sidebar-nav-item" id="newChatNavBtn">
                    <i class="fas fa-plus"></i>
                    <span>New chat</span>
                </button>
                <button class="sidebar-nav-item" onclick="window.location.href='/settings'">
                    <i class="fas fa-gear"></i>
                    <span>Settings</span>
                </button>
            </div>

            <div class="sidebar-chats" id="sidebarChats">
                <div class="sidebar-section-title">Your chats</div>
                <!-- Chat items will be dynamically loaded here -->
            </div>

            <div class="sidebar-footer">
                <div class="sidebar-user" id="userProfileBtn">
                    <div class="sidebar-user-avatar" id="userAvatar">
                        <%= user.name.charAt(0).toUpperCase() %>
                    </div>
                    <div class="sidebar-user-info">
                        <span class="sidebar-user-name"><%= user.name %></span>
                        <span class="sidebar-user-email"><%= user.email %></span>
                    </div>
                    <i class="fas fa-ellipsis sidebar-user-menu-icon"></i>
                </div>
                
                <!-- User Profile Dropdown -->
                <div class="user-dropdown" id="userDropdown">
                    <button class="user-dropdown-item" onclick="window.location.href='/settings'">
                        <i class="fas fa-gear"></i>
                        <span>Settings</span>
                    </button>
                    <button class="user-dropdown-item" id="logoutBtn">
                        <i class="fas fa-arrow-right-from-bracket"></i>
                        <span>Log out</span>
                    </button>
                </div>
            </div>
        </aside>

        <!-- ============================================ -->
        <!-- Main Content -->
        <!-- ============================================ -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="topbar">
                <div class="topbar-center">
                    <div class="topbar-title">
                        DarkBot
                        <span class="provider-badge" id="providerBadge">
                            <%= user.preferences.aiProvider === 'openai' ? 'ChatGPT' : 'Gemini' %>
                        </span>
                    </div>
                </div>
                <div class="topbar-right">
                    <button class="topbar-btn" id="newChatTopBtn" title="New Chat">
                        <i class="fas fa-pen-to-square"></i>
                    </button>
                </div>
            </div>

            <!-- Chat Messages Area -->
            <div class="chat-area" id="chatArea">
                <div class="messages-container" id="messagesContainer">
                    <!-- Welcome Screen - ChatGPT Style -->
                    <div class="welcome-screen" id="welcomeScreen">
                        <h1 class="welcome-title-main">Where should we begin?</h1>
                    </div>

                    <!-- Messages will be appended here -->
                </div>
            </div>

            <!-- Input Area - ChatGPT Style Pill -->
            <div class="input-area">
                <div class="input-wrapper">
                    <div class="input-container" id="inputContainer">
                        <button class="input-attach-btn" title="Attach" id="attachBtn">
                            <i class="fas fa-plus"></i>
                        </button>
                        <textarea
                            id="chatInput"
                            class="chat-input"
                            placeholder="Ask anything"
                            rows="1"
                            autofocus
                        ></textarea>
                        <div class="input-actions">
                            <button class="send-btn" id="sendBtn" disabled title="Send message">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                        </div>
                    </div>
                    <div class="input-footer">
                        DarkBot can make mistakes. Consider checking important information.
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="confirmTitle">Confirm Action</h3>
                <button class="modal-close" onclick="closeModal('confirmModal')">
                    <i class="fas fa-xmark"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmMessage">Are you sure?</p>
            </div>
            <div class="modal-footer">
                <button class="settings-btn outline" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="settings-btn danger" id="confirmAction">Delete</button>
            </div>
        </div>
    </div>

    <script>
    // ============================================
    // DarkBot Chat - Client-Side Logic
    // ============================================

    // State
    let currentChatId = null;
    let isLoading = false;
    const currentUser = <%- JSON.stringify(user) %>;
    const aiProvider = currentUser.preferences?.aiProvider || 'gemini';

    // DOM Elements
    const chatArea = document.getElementById('chatArea');
    const messagesContainer = document.getElementById('messagesContainer');
    const welcomeScreen = document.getElementById('welcomeScreen');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const sidebar = document.getElementById('sidebar');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop');
    const sidebarChats = document.getElementById('sidebarChats');

    // ============================================
    // Theme System
    // ============================================
    function applySystemTheme() {
        if (currentUser.preferences?.theme === 'system') {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        }
    }
    applySystemTheme();
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', applySystemTheme);

    // Sidebar Toggle
    // ============================================
    document.getElementById('sidebarCollapseBtn').addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        if (!sidebar.classList.contains('collapsed')) {
            sidebarBackdrop.classList.add('active');
        } else {
            sidebarBackdrop.classList.remove('active');
        }
    });

    sidebarBackdrop.addEventListener('click', () => {
        sidebar.classList.add('collapsed');
        sidebarBackdrop.classList.remove('active');
    });

    // Start with sidebar collapsed (icon bar only)
    sidebar.classList.add('collapsed');

    // ============================================
    // User Profile Dropdown
    // ============================================
    const userProfileBtn = document.getElementById('userProfileBtn');
    const userDropdown = document.getElementById('userDropdown');

    userProfileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const isActive = userDropdown.classList.toggle('active');
        userProfileBtn.classList.toggle('dropdown-open', isActive);
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
        if (!userDropdown.contains(e.target) && !userProfileBtn.contains(e.target)) {
            userDropdown.classList.remove('active');
            userProfileBtn.classList.remove('dropdown-open');
        }
    });

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', async () => {
        try {
            const res = await fetch('/auth/logout', { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                window.location.href = '/login';
            }
        } catch (err) {
            console.error('Logout failed:', err);
        }
    });

    // ============================================
    // Textarea Auto-resize
    // ============================================
    chatInput.addEventListener('input', () => {
        chatInput.style.height = 'auto';
        chatInput.style.height = Math.min(chatInput.scrollHeight, 200) + 'px';
        sendBtn.disabled = !chatInput.value.trim();
    });

    // Send message on Enter
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (chatInput.value.trim() && !isLoading) {
                sendMessage();
            }
        }
    });

    sendBtn.addEventListener('click', () => {
        if (chatInput.value.trim() && !isLoading) {
            sendMessage();
        }
    });

    // ============================================
    // New Chat
    // ============================================
    document.getElementById('newChatBtn').addEventListener('click', startNewChat);
    document.getElementById('newChatNavBtn').addEventListener('click', startNewChat);
    document.getElementById('newChatTopBtn').addEventListener('click', startNewChat);

    function startNewChat() {
        currentChatId = null;
        // Clear messages
        const messages = messagesContainer.querySelectorAll('.message, .typing-indicator');
        messages.forEach(m => m.remove());
        
        welcomeScreen.style.display = 'flex';
        chatInput.value = '';
        chatInput.style.height = 'auto';
        chatInput.focus();

        // Deselect sidebar items
        document.querySelectorAll('.chat-item').forEach(item => item.classList.remove('active'));

        chatInput.focus();

        // Close sidebar on mobile
        if (window.innerWidth <= 768) {
            sidebar.classList.add('collapsed');
            sidebarBackdrop.classList.remove('active');
        }
    }

    // ============================================
    // Send Message
    // ============================================
    async function sendMessage() {
        const message = chatInput.value.trim();
        if (!message || isLoading) return;

        isLoading = true;
        sendBtn.disabled = true;

        // Hide welcome screen
        welcomeScreen.style.display = 'none';

        // Add user message to chat
        addMessage('user', message);

        // Clear input
        chatInput.value = '';
        chatInput.style.height = 'auto';

        // Show typing indicator
        showTypingIndicator();

        try {
            const res = await fetch('/chat/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message,
                    chatId: currentChatId,
                    aiProvider
                })
            });

            const data = await res.json();

            // Remove typing indicator
            removeTypingIndicator();

            if (data.success) {
                currentChatId = data.chatId;

                // Add AI response
                addMessage('assistant', data.response);

                // Refresh sidebar
                loadChatHistory();
            } else {
                addMessage('assistant', 'âš ï¸ ' + (data.message || 'Something went wrong. Please try again.'));
            }
        } catch (err) {
            removeTypingIndicator();
            addMessage('assistant', 'âš ï¸ Network error. Please check your connection and try again.');
        }

        isLoading = false;
        sendBtn.disabled = false;
        chatInput.focus();
    }

    // ============================================
    // Message Rendering
    // ============================================
    function addMessage(role, content) {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${role}`;

        const avatarText = role === 'user'
            ? currentUser.name.charAt(0).toUpperCase()
            : 'ðŸ¤–';

        // Configure marked for markdown rendering
        marked.setOptions({
            breaks: true,
            gfm: true,
            highlight: false
        });

        const renderedContent = role === 'assistant'
            ? marked.parse(content)
            : escapeHtml(content).replace(/\n/g, '<br>');

        messageEl.innerHTML = `
            <div class="message-avatar">${avatarText}</div>
            <div class="message-body">
                <div class="message-role">${role === 'user' ? 'You' : 'DarkBot'}</div>
                <div class="message-content">${renderedContent}</div>
            </div>
        `;

        messagesContainer.appendChild(messageEl);

        // Add copy buttons to code blocks
        if (role === 'assistant') {
            messageEl.querySelectorAll('pre').forEach(pre => {
                const code = pre.querySelector('code');
                if (code) {
                    // Detect language
                    const langClass = code.className || '';
                    const lang = langClass.replace('language-', '') || 'code';

                    const header = document.createElement('div');
                    header.className = 'code-block-header';
                    header.innerHTML = `
                        <span>${lang}</span>
                        <button class="copy-code-btn" onclick="copyCode(this)">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    `;
                    pre.insertBefore(header, code);
                }
            });
        }

        scrollToBottom();
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function copyCode(btn) {
        const pre = btn.closest('pre');
        const code = pre.querySelector('code');
        navigator.clipboard.writeText(code.textContent).then(() => {
            btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
            setTimeout(() => {
                btn.innerHTML = '<i class="fas fa-copy"></i> Copy';
            }, 2000);
        });
    }

    // ============================================
    // Typing Indicator
    // ============================================
    function showTypingIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'typing-indicator';
        indicator.id = 'typingIndicator';
        indicator.innerHTML = `
            <div class="message-avatar" style="background: linear-gradient(135deg, var(--accent), #3b82f6); color: white;">ðŸ¤–</div>
            <div class="message-body">
                <div class="message-role">DarkBot</div>
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        `;
        messagesContainer.appendChild(indicator);
        scrollToBottom();
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typingIndicator');
        if (indicator) indicator.remove();
    }

    // ============================================
    // Scroll to Bottom
    // ============================================
    function scrollToBottom() {
        chatArea.scrollTo({
            top: chatArea.scrollHeight,
            behavior: 'smooth'
        });
    }

    // ============================================
    // Chat History
    // ============================================
    async function loadChatHistory() {
        try {
            const res = await fetch('/chat/history');
            const data = await res.json();

            if (data.success) {
                renderChatHistory(data.chats);
            }
        } catch (err) {
            console.error('Failed to load chat history:', err);
        }
    }

    function renderChatHistory(chats) {
        // Keep the section title
        sidebarChats.innerHTML = '<div class="sidebar-section-title">Your chats</div>';

        if (chats.length === 0) {
            sidebarChats.innerHTML += `
                <div style="text-align: center; padding: 20px; color: var(--text-tertiary); font-size: 13px;">
                    No chats yet. Start a new conversation!
                </div>
            `;
            return;
        }

        chats.forEach(chat => {
            const chatItem = document.createElement('div');
            chatItem.className = `chat-item ${chat._id === currentChatId ? 'active' : ''}`;
            chatItem.setAttribute('data-id', chat._id);
            chatItem.innerHTML = `
                <i class="fas fa-message chat-item-icon"></i>
                <span class="chat-item-title">${escapeHtml(chat.title)}</span>
                <button class="chat-item-menu" data-chat-id="${chat._id}" title="More options">
                    <i class="fas fa-ellipsis"></i>
                </button>
            `;
            
            // Click to load chat
            chatItem.addEventListener('click', (e) => {
                if (!e.target.closest('.chat-item-menu')) {
                    loadChat(chat._id);
                }
            });

            // Right-click context menu
            chatItem.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                showChatContextMenu(e, chat._id);
            });

            // Three dots menu click
            const menuBtn = chatItem.querySelector('.chat-item-menu');
            menuBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                showChatContextMenu(e, chat._id);
            });

            sidebarChats.appendChild(chatItem);
        });
    }

    // ============================================
    // Chat Context Menu
    // ============================================
    let currentContextMenu = null;

    function showChatContextMenu(event, chatId) {
        // Remove existing menu
        if (currentContextMenu) {
            currentContextMenu.remove();
        }

        // Create context menu
        const menu = document.createElement('div');
        menu.className = 'chat-context-menu';
        menu.innerHTML = `
            <button class="context-menu-item" data-action="rename">
                <i class="fas fa-pen"></i>
                <span>Rename</span>
            </button>
            <button class="context-menu-item danger" data-action="delete">
                <i class="fas fa-trash"></i>
                <span>Delete</span>
            </button>
        `;

        // Position menu
        document.body.appendChild(menu);
        
        const x = event.clientX;
        const y = event.clientY;
        const menuRect = menu.getBoundingClientRect();
        
        // Adjust position if menu goes off screen
        const left = (x + menuRect.width > window.innerWidth) ? x - menuRect.width : x;
        const top = (y + menuRect.height > window.innerHeight) ? y - menuRect.height : y;
        
        menu.style.left = left + 'px';
        menu.style.top = top + 'px';
        menu.classList.add('active');

        currentContextMenu = menu;

        // Handle menu actions
        menu.querySelectorAll('.context-menu-item').forEach(item => {
            item.addEventListener('click', () => {
                const action = item.getAttribute('data-action');
                if (action === 'delete') {
                    deleteChat(chatId);
                } else if (action === 'rename') {
                    // TODO: Implement rename functionality
                    showToast('Rename feature coming soon!', 'info');
                }
                menu.remove();
                currentContextMenu = null;
            });
        });

        // Close menu on outside click
        setTimeout(() => {
            document.addEventListener('click', function closeMenu(e) {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    currentContextMenu = null;
                    document.removeEventListener('click', closeMenu);
                }
            });
        }, 0);
    }

    // ============================================
    // Load Specific Chat
    // ============================================
    async function loadChat(chatId) {
        try {
            const res = await fetch(`/chat/${chatId}`);
            const data = await res.json();

            if (data.success) {
                currentChatId = chatId;

                // Clear current messages
                const messages = messagesContainer.querySelectorAll('.message, .typing-indicator');
                messages.forEach(m => m.remove());
                welcomeScreen.style.display = 'none';

                // Add messages
                data.chat.messages.forEach(msg => {
                    if (msg.role === 'user' || msg.role === 'assistant') {
                        addMessage(msg.role, msg.content);
                    }
                });

                // Update active state
                document.querySelectorAll('.chat-item').forEach(item => {
                    item.classList.toggle('active', item.getAttribute('data-id') === chatId);
                });

                // Close sidebar on mobile
                if (window.innerWidth <= 768) {
                    sidebar.classList.add('collapsed');
                    sidebarBackdrop.classList.remove('active');
                }
            }
        } catch (err) {
            showToast('Failed to load chat', 'error');
        }
    }

    // ============================================
    // Delete Chat
    // ============================================
    function deleteChat(chatId) {
        showConfirm('Delete Chat', 'Are you sure you want to delete this chat?', async () => {
            try {
                const res = await fetch(`/chat/${chatId}`, { method: 'DELETE' });
                const data = await res.json();

                if (data.success) {
                    if (currentChatId === chatId) {
                        startNewChat();
                    }
                    loadChatHistory();
                    showToast('Chat deleted', 'success');
                }
            } catch (err) {
                showToast('Failed to delete chat', 'error');
            }
        });
    }

    // ============================================
    // Confirm Modal
    // ============================================
    function showConfirm(title, message, onConfirm) {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = message;
        document.getElementById('confirmModal').classList.add('active');

        const actionBtn = document.getElementById('confirmAction');
        const newBtn = actionBtn.cloneNode(true);
        actionBtn.parentNode.replaceChild(newBtn, actionBtn);
        newBtn.id = 'confirmAction';
        newBtn.addEventListener('click', () => {
            closeModal('confirmModal');
            onConfirm();
        });
    }

    function closeModal(id) {
        document.getElementById(id).classList.remove('active');
    }

    // Close modal on overlay click
    document.getElementById('confirmModal').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeModal('confirmModal');
    });

    // ============================================
    // Toast Notifications
    // ============================================
    function showToast(message, type = 'info') {
        const container = document.getElementById('toastContainer');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;

        const icon = type === 'success' ? 'fa-check-circle'
            : type === 'error' ? 'fa-exclamation-circle'
            : 'fa-info-circle';

        toast.innerHTML = `<i class="fas ${icon}"></i>${message}`;
        container.appendChild(toast);

        setTimeout(() => toast.remove(), 4000);
    }

    // ============================================
    // Initialize
    // ============================================
    loadChatHistory();
    chatInput.focus();
    </script>
</body>
</html>
