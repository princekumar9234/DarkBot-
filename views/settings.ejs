<!DOCTYPE html>
<html lang="en" data-theme="<%= user.preferences.theme === 'system' ? 'dark' : user.preferences.theme %>">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="description" content="DarkBot Settings - Customize your experience.">
    <meta name="theme-color" content="#8b5cf6">
    <title><%= title %></title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --accent: <%= user.preferences.accentColor || '#8b5cf6' %>; 
            --font-outfit: 'Outfit', sans-serif;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
        }

        .settings-header h1 {
            font-family: var(--font-outfit);
            font-weight: 800;
            letter-spacing: -1px;
        }

        .settings-section-title {
            font-family: var(--font-outfit);
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--accent);
        }

        .sidebar-header {
            padding: 20px;
        }

        .back-chat-btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        .back-chat-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--accent);
        }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }

        .modal {
            background: #111;
            border: 1px solid var(--border-color);
            border-radius: 24px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
        }

        .form-group input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 16px;
            color: #fff;
            width: 100%;
        }

        .form-group input:focus {
            border-color: var(--accent);
            background: rgba(255, 255, 255, 0.06);
        }

        .toggle-password {
            position: absolute;
            right: 12px;
            bottom: 10px;
            cursor: pointer;
            color: #666;
            z-index: 5;
        }

        .toggle-password:hover { color: #fff; }
    </style>
</head>
<body>
    <div class="mesh-bg" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 0% 0%, rgba(139, 92, 246, 0.05) 0%, transparent 50%), #0d0d0d;"></div>
    
    <div class="app-layout">
        <!-- Mobile Sidebar Backdrop -->
        <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="back-chat-btn" onclick="window.location.href='/chat'">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Chat</span>
                </button>
            </div>

            <div class="sidebar-chats" style="flex: 1;"></div>

            <div class="sidebar-footer">
                <div class="sidebar-user">
                    <div class="sidebar-user-avatar">
                        <%= user.name.charAt(0).toUpperCase() %>
                    </div>
                    <span class="sidebar-user-name"><%= user.name %></span>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <div class="topbar">
                <div class="topbar-left">
                    <button class="topbar-btn" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="topbar-title-pill" style="background: transparent; border: none;">
                        <img src="/img/sharingan-logo.svg" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 8px;">
                        <span style="font-family: 'Outfit'; font-weight: 700;">Settings</span>
                    </div>
                </div>
                <div class="topbar-right">
                    <button class="topbar-btn" onclick="window.location.href='/chat'" title="Back to chat">
                        <i class="fas fa-message"></i>
                    </button>
                </div>
            </div>

            <!-- Settings Content -->
            <div class="settings-page">
                <div class="settings-container">
                    <div class="settings-header">
                        <h1>Settings</h1>
                        <p>Manage your account and customize DarkBot</p>
                    </div>

                    <!-- Profile Section -->
                    <div class="settings-section">
                        <div class="settings-section-title">
                            <i class="fas fa-user"></i> Profile
                        </div>

                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Name</div>
                                <div class="settings-item-desc" id="profileName"><%= user.name %></div>
                            </div>
                            <div class="settings-item-action">
                                <button class="settings-btn outline" onclick="editProfile('name')">
                                    <i class="fas fa-pencil"></i>
                                </button>
                            </div>
                        </div>

                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Email</div>
                                <div class="settings-item-desc" id="profileEmail"><%= user.email %></div>
                            </div>
                            <div class="settings-item-action">
                                <button class="settings-btn outline" onclick="editProfile('email')">
                                    <i class="fas fa-pencil"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Appearance Section -->
                    <div class="settings-section">
                        <div class="settings-section-title">
                            <i class="fas fa-palette"></i> Appearance
                        </div>

                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Theme</div>
                            </div>
                            <div class="settings-item-action">
                                <div class="theme-selector">
                                    <button class="theme-option <%= user.preferences.theme === 'light' ? 'active' : '' %>" data-theme="light" onclick="setTheme('light')">Light</button>
                                    <button class="theme-option <%= user.preferences.theme === 'dark' ? 'active' : '' %>" data-theme="dark" onclick="setTheme('dark')">Dark</button>
                                    <button class="theme-option <%= user.preferences.theme === 'system' ? 'active' : '' %>" data-theme="system" onclick="setTheme('system')">Auto</button>
                                </div>
                            </div>
                        </div>

                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Accent Color</div>
                            </div>
                            <div class="settings-item-action">
                                <div class="accent-colors">
                                    <button class="accent-color-option" style="background: #8b5cf6;" data-color="#8b5cf6" onclick="setAccentColor('#8b5cf6')"></button>
                                    <button class="accent-color-option" style="background: #3b82f6;" data-color="#3b82f6" onclick="setAccentColor('#3b82f6')"></button>
                                    <button class="accent-color-option" style="background: #10b981;" data-color="#10b981" onclick="setAccentColor('#10b981')"></button>
                                    <button class="accent-color-option" style="background: #f59e0b;" data-color="#f59e0b" onclick="setAccentColor('#f59e0b')"></button>
                                    <button class="accent-color-option" style="background: #ef4444;" data-color="#ef4444" onclick="setAccentColor('#ef4444')"></button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Provider -->
                    <div class="settings-section">
                        <div class="settings-section-title">
                            <i class="fas fa-brain"></i> AI Engine
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Default Provider</div>
                            </div>
                            <div class="settings-item-action">
                                <div class="provider-selector">
                                    <button class="provider-option <%= user.preferences.aiProvider === 'gemini' ? 'active' : '' %>" onclick="setAiProvider('gemini')">Gemini</button>
                                    <button class="provider-option <%= user.preferences.aiProvider === 'openai' ? 'active' : '' %>" onclick="setAiProvider('openai')">GPT-4o</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Security -->
                    <div class="settings-section">
                        <div class="settings-section-title">
                            <i class="fas fa-shield-halved"></i> Privacy & Security
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Password</div>
                            </div>
                            <div class="settings-item-action">
                                <button class="settings-btn outline" onclick="showPasswordModal()">Change</button>
                            </div>
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Log Out</div>
                            </div>
                            <div class="settings-item-action">
                                <button class="settings-btn outline" onclick="logout()">Log Out</button>
                            </div>
                        </div>
                    </div>

                    <!-- Data -->
                    <div class="settings-section">
                        <div class="settings-section-title" style="color: var(--error);">
                            <i class="fas fa-triangle-exclamation"></i> Danger Zone
                        </div>
                        <div class="settings-item">
                            <div class="settings-item-info">
                                <div class="settings-item-label">Clear Chats</div>
                            </div>
                            <div class="settings-item-action">
                                <button class="settings-btn danger" onclick="clearAllChats()">Delete All</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="passwordModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Change Password</h3>
                <button class="modal-close" onclick="closeModal('passwordModal')"><i class="fas fa-xmark"></i></button>
            </div>
            <div class="modal-body">
                <div class="auth-error" id="passwordError"></div>
                <div class="form-group" style="position: relative; margin-bottom: 20px;">
                    <label>Current Password</label>
                    <div class="password-wrapper" style="position: relative;">
                        <input type="password" id="currentPassword" placeholder="••••••••" style="padding-right: 42px;">
                        <button type="button" class="toggle-password" onclick="togglePassword('currentPassword')" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #666; cursor: pointer; padding: 4px; z-index: 10; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-eye" id="currentPasswordIcon" style="pointer-events: none;"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group" style="position: relative; margin-bottom: 20px;">
                    <label>New Password</label>
                    <div class="password-wrapper" style="position: relative;">
                        <input type="password" id="newPassword" placeholder="••••••••" style="padding-right: 42px;">
                        <button type="button" class="toggle-password" onclick="togglePassword('newPassword')" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #666; cursor: pointer; padding: 4px; z-index: 10; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-eye" id="newPasswordIcon" style="pointer-events: none;"></i>
                        </button>
                    </div>
                </div>
                <div class="form-group" style="position: relative;">
                    <label>Confirm New Password</label>
                    <div class="password-wrapper" style="position: relative;">
                        <input type="password" id="confirmNewPassword" placeholder="••••••••" style="padding-right: 42px;">
                        <button type="button" class="toggle-password" onclick="togglePassword('confirmNewPassword')" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #666; cursor: pointer; padding: 4px; z-index: 10; display: flex; align-items: center; justify-content: center;">
                            <i class="fa-solid fa-eye" id="confirmNewPasswordIcon" style="pointer-events: none;"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="settings-btn outline" onclick="closeModal('passwordModal')">Cancel</button>
                <button class="settings-btn primary" onclick="changePassword()" id="changePasswordBtn">Update Password</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal">
            <div class="modal-header"><h3 id="confirmTitle">Confirm</h3></div>
            <div class="modal-body"><p id="confirmMessage"></p></div>
            <div class="modal-footer">
                <button class="settings-btn outline" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="settings-btn danger" id="confirmAction">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal-overlay" id="editProfileModal">
        <div class="modal">
            <div class="modal-header"><h3 id="editProfileTitle">Edit</h3></div>
            <div class="modal-body">
                <div class="form-group">
                    <label id="editProfileLabel">Label</label>
                    <input type="text" id="editProfileInput">
                </div>
            </div>
            <div class="modal-footer">
                <button class="settings-btn outline" onclick="closeModal('editProfileModal')">Cancel</button>
                <button class="settings-btn primary" id="saveProfileBtn">Save</button>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script>
    // Safe injection of user data to avoid linting errors and parsing issues
    const currentUser = JSON.parse(decodeURIComponent('<%= encodeURIComponent(JSON.stringify(user || {})) %>'));

    function togglePassword(id) {
        console.log('Toggling password for:', id);
        const input = document.getElementById(id);
        const icon = document.getElementById(id + 'Icon');
        
        if (!input || !icon) {
            console.error('Password toggle elements not found:', id);
            return;
        }

                if (input.type === 'password') {
                    input.type = 'text';
                    icon.classList.remove('fa-eye');
                    icon.classList.add('fa-eye-slash');
                } else {
                    input.type = 'password';
                    icon.classList.remove('fa-eye-slash');
                    icon.classList.add('fa-eye');
                }
    }

    const sidebar = document.getElementById('sidebar');
    const sidebarBackdrop = document.getElementById('sidebarBackdrop');
    document.getElementById('sidebarToggle').addEventListener('click', () => {
        sidebar.classList.toggle('collapsed');
        sidebarBackdrop.classList.toggle('active');
    });

    function setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme === 'system' ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light') : theme);
        document.querySelectorAll('.theme-option').forEach(opt => opt.classList.toggle('active', opt.dataset.theme === theme));
        updatePreferences({ theme });
    }

    function setAccentColor(color) {
        document.documentElement.style.setProperty('--accent', color);
        updatePreferences({ accentColor: color });
    }

    function setAiProvider(provider) {
        updatePreferences({ aiProvider: provider });
        setTimeout(() => location.reload(), 500);
    }

    async function updatePreferences(data) {
        try {
            await fetch('/user/preferences', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            showToast('Settings saved', 'success');
        } catch (err) { showToast('Error saving settings', 'error'); }
    }

    function editProfile(field) {
        const modal = document.getElementById('editProfileModal');
        const input = document.getElementById('editProfileInput');
        document.getElementById('editProfileLabel').textContent = field.charAt(0).toUpperCase() + field.slice(1);
        input.value = currentUser[field];
        modal.classList.add('active');
        document.getElementById('saveProfileBtn').onclick = async () => {
            try {
                const res = await fetch('/user/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ [field]: input.value })
                });
                const data = await res.json();
                if (data.success) {
                    location.reload();
                } else { showToast(data.message, 'error'); }
            } catch (err) { showToast('Error', 'error'); }
        };
    }

    function showPasswordModal() { document.getElementById('passwordModal').classList.add('active'); }
    async function changePassword() {
        // Implementation similar to login/signup
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmNewPassword').value;
        const err = document.getElementById('passwordError');
        
        if (newPassword !== confirmPassword) {
            err.textContent = "Passwords don't match";
            err.classList.add('show');
            return;
        }

        try {
            const res = await fetch('/user/password', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ currentPassword, newPassword, confirmPassword })
            });
            const data = await res.json();
            if (data.success) {
                showToast('Password updated', 'success');
                closeModal('passwordModal');
            } else {
                err.textContent = data.message;
                err.classList.add('show');
            }
        } catch (err) { showToast('Error', 'error'); }
    }

    async function logout() { await fetch('/auth/logout', { method: 'POST' }); location.href = '/'; }

    function clearAllChats() {
        showConfirm('Clear History', 'Delete all chats?', async () => {
            await fetch('/chat/clear/all', { method: 'DELETE' });
            showToast('History cleared', 'success');
        });
    }

    function showConfirm(title, msg, onConfirm) {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmMessage').textContent = msg;
        document.getElementById('confirmModal').classList.add('active');
        document.getElementById('confirmAction').onclick = () => { closeModal('confirmModal'); onConfirm(); };
    }

    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    function showToast(msg, type) {
        const t = document.createElement('div');
        t.className = `toast ${type}`;
        t.textContent = msg;
        document.getElementById('toastContainer').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }
    </script>
</body>
</html>
